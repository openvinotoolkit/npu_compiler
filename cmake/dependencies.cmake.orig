# Copyright (C) 2018-2019 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0
#

cmake_policy(SET CMP0054 NEW)

#features trigger supported by build system
include(check_features)
include(debug)
include(models)

#we have number of dependencies stored on ftp
include(dependency_solver)

#prepare temporary folder
if (DEFINED ENV{${DL_SDK_TEMP}})
    if (WIN32)
        string(REPLACE "\\" "\\\\" TEMP $ENV{${DL_SDK_TEMP}})
    else(WIN32)
        set(TEMP $ENV{${DL_SDK_TEMP}})
    endif(WIN32)

    if (ENABLE_ALTERNATIVE_TEMP)
        set(ALTERNATIVE_PATH ${IE_MAIN_SOURCE_DIR}/temp)
    endif()
else ()
    message(STATUS "DL_SDK_TEMP envionment not set")
    set(TEMP ${IE_MAIN_SOURCE_DIR}/temp)
endif ()


include(ExternalProject)

if (ENABLE_SAME_BRANCH_FOR_MODELS)
    branchName(MODELS_BRANCH)
else()
    set(MODELS_BRANCH "master")
endif()

set(MODELS_PATH "${TEMP}/models")
debug_message(STATUS "MODELS_PATH=" ${MODELS_PATH})

#validation set repository added always by default
#add_validation_set_repo(${ENABLE_FUNCTIONAL_TESTS}  "validation_set:inference-engine/validation-set.git")

add_models_repo(${ENABLE_MODELS}                "models:inference-engine/models-ir.git")
add_models_repo(${ENABLE_PRIVATE_MODELS}        "models_private:inference-engine-models/private-ir.git")
add_models_repo(${ENABLE_PRIVATE_HDDL_MODELS}   "models_hddl_private:hddl/hddl-private-ir.git")
add_models_repo(${ENABLE_MODELS_FOR_CVSDK}      "models-for-cvsdk:inference-engine-models/models-for-cvsdk.git" "ie_regression")

fetch_models_and_validation_set()

if (ENABLE_OPENVX)
    #openvx IAP
    RESOLVE_OVX_IAP_DEPENDENCY(OPENVX "${TEMP}/openvx")
    debug_message(STATUS "openvx-iap=" ${OPENVX})
endif ()

if (ENABLE_MYRIAD)
    RESOLVE_DEPENDENCY(VPU_FIRMWARE_MA2450
<<<<<<< HEAD
            ARCHIVE_UNIFIED VPU/ma2450/firmware_ma2450_418.zip
=======
            ARCHIVE_UNIFIED VPU/ma2450/firmware_ma2450_413.zip
>>>>>>> [IE VPU] Return NC_OUT_OF_MEMORY in ncGraphAllocate if not enough memory
            TARGET_PATH "${TEMP}/vpu/firmware/ma2450"
            ENVIRONMENT "VPU_FIRMWARE_MA2450"
            FOLDER)
    debug_message(STATUS "ma2450=" ${VPU_FIRMWARE_MA2450})
endif ()

if (ENABLE_MYRIAD OR ENABLE_HDDL OR ENABLE_KMB)
    RESOLVE_DEPENDENCY(VPU_FIRMWARE_MA2480
<<<<<<< HEAD
            ARCHIVE_UNIFIED VPU/ma2480/firmware_ma2480_418.zip
=======
            ARCHIVE_UNIFIED VPU/ma2480/firmware_ma2480_413.zip
>>>>>>> [IE VPU] Return NC_OUT_OF_MEMORY in ncGraphAllocate if not enough memory
            TARGET_PATH "${TEMP}/vpu/firmware/ma2480"
            ENVIRONMENT "VPU_FIRMWARE_MA2480"
            FOLDER)
    debug_message(STATUS "ma2480=" ${VPU_FIRMWARE_MA2480})
endif ()

if (ENABLE_KMB)
    include(Fetch_mcmCompiler)
    fetch_mcmCompiler("kskvorts/graphfile_relative_url")
    debug_message(STATUS "add mcmCompiler thirdparty")
endif ()

if (ENABLE_HDDL)
    if (WIN32)
        RESOLVE_DEPENDENCY(HDDL
                ARCHIVE_WIN hddl/hddl_windows10_419.zip
                TARGET_PATH "${TEMP}/vpu/hddl"
                ENVIRONMENT "HDDL")
    elseif(LINUX)
        if (${LINUX_OS_NAME} STREQUAL "Ubuntu 18.04")
            RESOLVE_DEPENDENCY(HDDL
                    ARCHIVE_LIN hddl/hddl_ubuntu18_419.tar.gz
                    TARGET_PATH "${TEMP}/vpu/hddl"
                    ENVIRONMENT "HDDL")
        else()
            # TODO: CentOS vs Ubuntu 16.04?
            RESOLVE_DEPENDENCY(HDDL
                    ARCHIVE_LIN hddl/hddl_ubuntu16_419.tar.gz
                    TARGET_PATH "${TEMP}/vpu/hddl"
                    ENVIRONMENT "HDDL")
        endif()
    endif()
    debug_message(STATUS "hddl=" ${HDDL})
endif ()

if (ENABLE_DLIA)
    if (WIN32)
        RESOLVE_DEPENDENCY(AOCL_RTE
                ARCHIVE_WIN "aoclrte-windows64_18.1.1.263.zip"
                TARGET_PATH "${TEMP}/aocl-rte"
                VERSION_REGEX ".*_(([a-z]+-)?[a-z]+-[0-9]+)---.*"
                ENVIRONMENT "AOCL_RTE")
        log_rpath_from_dir(AOCL_RTE "aocl-rte\\windows64\\bin")
    elseif(LINUX)
        RESOLVE_DEPENDENCY(AOCL_RTE
                ARCHIVE_LIN "aocl-rte_18.1.1.263p.tar.gz"
                TARGET_PATH "${TEMP}/aocl-rte"
                VERSION_REGEX ".*_(([a-z]+-)?[a-z]+-[0-9]+)---.*"
                ENVIRONMENT "AOCL_RTE")
        log_rpath_from_dir(AOCL_RTE "aocl-rte/linux64/lib")
    endif()
    message(STATUS "AOCL_RTE=" ${AOCL_RTE})
endif ()


if (ENABLE_OPENVX_CVE)
    #openVX - CVE-emu
    RESOLVE_DEPENDENCY(OPENVX_CVE
            ARCHIVE_LIN openvx_cve_emulator-0.7.0.039.tgz
            TARGET_PATH "${TEMP}/openvx-cve"
            ENVIRONMENT "OPENVX_CVE")
    debug_message(STATUS "openvx-cve=" ${OPENVX_CVE})
endif ()

## enable cblas_gemm from OpenBLAS package
if (GEMM STREQUAL "OPENBLAS")
if(NOT BLAS_LIBRARIES OR NOT BLAS_INCLUDE_DIRS)
    find_package(BLAS REQUIRED)
    if(BLAS_FOUND)
        find_path(BLAS_INCLUDE_DIRS cblas.h)
    else()
        message(ERROR "OpenBLAS not found: install OpenBLAS or set -DBLAS_INCLUDE_DIRS=<path to dir with cblas.h> and -DBLAS_LIBRARIES=<path to libopenblas.so or openblas.lib>")
    endif()
endif()
debug_message(STATUS "openblas=" ${BLAS_LIBRARIES})
endif ()

## enable cblas_gemm from MKL-ml package
if (GEMM STREQUAL "MKL")
if (WIN32)
    #TODO: add target_path to be platform specific as well, to avoid following if
    RESOLVE_DEPENDENCY(MKL
            ARCHIVE_WIN "mkltiny_win_20190131.zip"
            TARGET_PATH "${TEMP}/mkltiny_win_20190131"
            ENVIRONMENT "MKLROOT"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
elseif(LINUX)
    RESOLVE_DEPENDENCY(MKL
            ARCHIVE_LIN "mkltiny_lnx_20190131.tgz"
            TARGET_PATH "${TEMP}/mkltiny_lnx_20190131"
            ENVIRONMENT "MKLROOT"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
else(APPLE)
    RESOLVE_DEPENDENCY(MKL
            ARCHIVE_MAC "mkltiny_mac_20190131.tgz"
            TARGET_PATH "${TEMP}/mkltiny_mac_20190131"
            ENVIRONMENT "MKLROOT"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
endif()
debug_message(STATUS "mkl_ml=" ${MKL})
endif ()

## Intel OMP package
if (THREADING STREQUAL "OMP")
if (WIN32)
    RESOLVE_DEPENDENCY(OMP
            ARCHIVE_WIN "iomp.zip"
            TARGET_PATH "${TEMP}/omp"
            ENVIRONMENT "OMP"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
elseif(LINUX)
    RESOLVE_DEPENDENCY(OMP
            ARCHIVE_LIN "iomp.tgz"
            TARGET_PATH "${TEMP}/omp"
            ENVIRONMENT "OMP"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
else(APPLE)
    RESOLVE_DEPENDENCY(OMP
            ARCHIVE_MAC "iomp_20190130_mac.tgz"
            TARGET_PATH "${TEMP}/omp"
            ENVIRONMENT "OMP"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
endif()
log_rpath_from_dir(OMP "${OMP}/lib")
debug_message(STATUS "intel_omp=" ${OMP})
endif ()

## TBB package
if (THREADING STREQUAL "TBB")
if (WIN32)
    #TODO: add target_path to be platform specific as well, to avoid following if
    RESOLVE_DEPENDENCY(TBB
            ARCHIVE_WIN "tbb2019_20181010_win.zip" #TODO: windows zip archive created incorrectly using old name for folder
            TARGET_PATH "${TEMP}/tbb"
            ENVIRONMENT "TBBROOT"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
elseif(LINUX)
    RESOLVE_DEPENDENCY(TBB
            ARCHIVE_LIN "tbb2019_20181010_lin.tgz"
            TARGET_PATH "${TEMP}/tbb"
            ENVIRONMENT "TBBROOT")
else(APPLE)
    RESOLVE_DEPENDENCY(TBB
            ARCHIVE_MAC "tbb2019_20190130_mac.tgz"
            TARGET_PATH "${TEMP}/tbb"
            ENVIRONMENT "TBBROOT"
            VERSION_REGEX ".*_([a-z]*_([a-z0-9]+\\.)*[0-9]+).*")
endif()
log_rpath_from_dir(TBB "${TBB}/lib")
debug_message(STATUS "tbb=" ${TBB})
endif ()

if (ENABLE_OPENCV)
if (WIN32)
    RESOLVE_DEPENDENCY(OPENCV
            ARCHIVE_WIN "opencv/opencv_4.1.0-0437.zip"
            TARGET_PATH "${TEMP}/opencv_4.1.0"
            ENVIRONMENT "OpenCV_DIR"
            VERSION_REGEX ".*_([0-9]+.[0-9]+.[0-9]+).*")
    log_rpath_from_dir(OPENCV "\\opencv_4.1.0\\bin")
    set( ENV{OpenCV_DIR} ${OPENCV}/cmake )
elseif(APPLE)
    RESOLVE_DEPENDENCY(OPENCV
            ARCHIVE_MAC "opencv/opencv_4.1.0-0437_osx.tar.xz"
            TARGET_PATH "${TEMP}/opencv_4.1.0_osx"
            ENVIRONMENT "OpenCV_DIR"
            VERSION_REGEX ".*_([0-9]+.[0-9]+.[0-9]+).*")
    log_rpath_from_dir(OPENCV "opencv_4.1.0_osx/lib")
    set( ENV{OpenCV_DIR} ${OPENCV}/cmake )
elseif(LINUX)
if (${LINUX_OS_NAME} STREQUAL "Ubuntu 16.04")
    RESOLVE_DEPENDENCY(OPENCV
            ARCHIVE_LIN "opencv/opencv_4.1.0-0437_ubuntu16.tar.xz"
            TARGET_PATH "${TEMP}/opencv_4.1.0_ubuntu16"
            ENVIRONMENT "OpenCV_DIR"
            VERSION_REGEX ".*_([0-9]+.[0-9]+.[0-9]+).*")
    log_rpath_from_dir(OPENCV "opencv_4.1.0_ubuntu16/lib")
elseif (${LINUX_OS_NAME} STREQUAL "Ubuntu 18.04")
    RESOLVE_DEPENDENCY(OPENCV
            ARCHIVE_LIN "opencv/opencv_4.1.0-0437_ubuntu18.tar.xz"
            TARGET_PATH "${TEMP}/opencv_4.1.0_ubuntu18"
            ENVIRONMENT "OpenCV_DIR"
            VERSION_REGEX ".*_([0-9]+.[0-9]+.[0-9]+).*")
    log_rpath_from_dir(OPENCV "opencv_4.1.0_ubuntu18/lib")
elseif (${LINUX_OS_NAME} STREQUAL "CentOS 7")
    RESOLVE_DEPENDENCY(OPENCV
            ARCHIVE_LIN "opencv/opencv_4.1.0-0437_centos7.tar.xz"
            TARGET_PATH "${TEMP}/opencv_4.1.0_centos"
            ENVIRONMENT "OpenCV_DIR"
            VERSION_REGEX ".*_([0-9]+.[0-9]+.[0-9]+).*")
    log_rpath_from_dir(OPENCV "opencv_4.1.0_centos/lib")
elseif (${CMAKE_SYSTEM_PROCESSOR} STREQUAL "armv7l" AND
        (${LINUX_OS_NAME} STREQUAL "Debian 9" OR
         ${LINUX_OS_NAME} STREQUAL "Raspbian 9"))
    RESOLVE_DEPENDENCY(OPENCV
            ARCHIVE_LIN "opencv/opencv_4.1.0-0437_debian9arm.tar.xz"
            TARGET_PATH "${TEMP}/opencv_4.1.0_debian9arm"
            ENVIRONMENT "OpenCV_DIR"
            VERSION_REGEX ".*_([0-9]+.[0-9]+.[0-9]+).*")
    log_rpath_from_dir(OPENCV "opencv_4.1.0_debian9arm/lib")
endif()
    set( ENV{OpenCV_DIR} ${OPENCV}/cmake )
endif()
debug_message(STATUS "opencv=" ${OPENCV})
endif()

if (ENABLE_DAAL)
    RESOLVE_DEPENDENCY(DAAL
            ARCHIVE "daal_icc160_r14150.tgz"
            TARGET_PATH "${TEMP}/${DAAL_TARGET_DIR}"
            ENVIRONMENT "DAAL")
    debug_message(STATUS "daal=" ${DAAL})

endif ()

include(ie_parallel)

if (ENABLE_INTEGRATION_TESTS)
    #Model Optimizer
    RESOLVE_DEPENDENCY(MODELOPTIMIZER_BIN_DIR
            ARCHIVE utils/mo_linux_x64_release.tar.bz2
            TARGET_PATH "${TEMP}/utils/ModelOptimizer"
            ENVIRONMENT "MODELOPTIMIZER_BIN_DIR")
endif()

if (ENABLE_GNA)
    RESOLVE_DEPENDENCY(GNA
            ARCHIVE_UNIFIED "GNA/gna_20181120.zip"
            TARGET_PATH "${TEMP}/gna")
endif()

configure_file(
        "${CMAKE_SOURCE_DIR}/cmake/share/InferenceEngineConfig.cmake.in"
        "${CMAKE_BINARY_DIR}/share/InferenceEngineConfig.cmake"
        @ONLY)

configure_file(
        "${CMAKE_SOURCE_DIR}/cmake/share/InferenceEngineConfig-version.cmake.in"
        "${CMAKE_BINARY_DIR}/share/InferenceEngineConfig-version.cmake"
        COPYONLY)

configure_file(
        "${CMAKE_SOURCE_DIR}/cmake/ie_parallel.cmake"
        "${CMAKE_BINARY_DIR}/share/ie_parallel.cmake"
        COPYONLY)
